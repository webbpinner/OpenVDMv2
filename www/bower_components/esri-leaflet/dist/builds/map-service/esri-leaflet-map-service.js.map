{"version":3,"sources":["../../../src/EsriLeaflet.js","../../../src/Util.js","../../../src/Request.js","../../../src/Services/Service.js","../../../src/Services/MapService.js","../../../src/Tasks/Task.js","../../../src/Tasks/Identify.js","../../../src/Tasks/IdentifyFeatures.js","../../../src/Tasks/Query.js","../../../src/Tasks/Find.js","../../../src/Layers/RasterLayer.js","../../../src/Layers/DynamicMapLayer.js","../../../src/Layers/TiledMapLayer.js"],"names":["EsriLeaflet","VERSION","Layers","Services","Controls","Tasks","Util","Support","CORS","window","XMLHttpRequest","pointerEvents","document","documentElement","style","L","esri","clone","obj","target","i","hasOwnProperty","pointsEqual","a","b","length","closeRing","coordinates","push","ringIsClockwise","ringToTest","pt2","total","rLength","pt1","vertexIntersectsVertex","a1","a2","b1","b2","uaT","ubT","uB","ua","ub","arrayIntersectsArray","j","coordinatesContainPoint","point","contains","l","coordinatesContainCoordinates","outer","inner","intersects","convertRingsToGeoJSON","rings","x","outerRing","hole","outerRings","holes","r","ring","slice","polygon","uncontainedHoles","pop","contained","reverse","type","orientRings","poly","output","shift","flattenMultiPolygonRings","raf","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame","cb","setTimeout","extentToBounds","extent","sw","LatLng","ymin","xmin","ne","ymax","xmax","LatLngBounds","boundsToExtent","bounds","latLngBounds","getSouthWest","lng","lat","getNorthEast","spatialReference","wkid","arcgisToGeojson","arcgis","idAttribute","geojson","y","points","paths","geometry","attributes","properties","id","OBJECTID","FID","geojsonToArcGIS","result","features","geometries","responseToFeatureCollection","response","objectIdField","objectIdFieldName","fields","name","featureCollection","results","cleanUrl","url","replace","isArcgisOnline","test","geojsonTypeToArcGIS","geoJsonType","arcgisGeometryType","bind","warn","message","console","serialize","params","data","f","key","value","param","Object","prototype","toString","call","JSON","stringify","join","valueOf","encodeURIComponent","createRequest","callback","context","httpRequest","onerror","e","onreadystatechange","falseFn","error","code","readyState","parse","responseText","callbacks","_EsriLeafletCallbacks","Request","request","paramString","requestLength","open","send","get","JSONP","setRequestHeader","post","XMLHTTP","callbackId","script","DomUtil","create","body","src","responseType","abort","_callback","Service","Class","extend","includes","Mixin","Events","options","proxy","useCors","initialize","this","_requestQueue","_authenticating","setOptions","path","_request","metadata","authenticate","token","_runQueue","method","fire","wrappedCallback","_createServiceCallback","apply","service","MapService","identify","identifyFeatures","find","Find","query","Query","mapService","Task","generateSetter","endpoint","_service","setters","setter","Identify","between","start","end","time","IdentifyFeatures","layers","precision","tolerance","returnGeometry","sr","on","map","getBounds","size","getSize","imageDisplay","mapExtent","at","latlng","latLng","geometryType","layerDef","where","layerDefs","simplify","factor","mapWidth","Math","abs","getWest","getEast","maxAllowableOffset","run","undefined","layerId","offset","limit","featureIds","outSr","outFields","within","_setGeometry","spatialRel","overlaps","nearby","radius","units","distance","inSr","string","orderBy","fieldName","order","orderByFields","_cleanParams","_trapSQLerrors","count","returnCountOnly","ids","returnIdsOnly","objectIds","returnExtentOnly","pixelSize","layer","getLatLng","GeoJSON","getLayers","feature","toGeoJSON","text","dynamicLayers","returnZ","returnM","gdbVersion","RasterLayer","opacity","position","onAdd","_map","_update","limitExecByInterval","updateInterval","crs","split","bboxSR","imageSR","_currentImage","_bounds","equals","addLayer","removeLayer","_popup","_getPopupData","_resetPopupState","bindPopup","fn","popupOptions","_shouldRenderPopup","_lastClick","popup","_popupFunction","unbindPopup","closePopup","off","onRemove","addTo","removeFrom","bringToFront","bringToBack","getAttribution","attribution","getOpacity","setOpacity","getTimeRange","from","to","setTimeRange","_renderImage","ImageOverlay","once","newImage","oldImage","zoom","getZoom","_animatingZoom","_panTransition","_inProgress","maxZoom","minZoom","_buildExportParams","_requestExport","_renderPopup","content","setLatLng","setContent","openOn","_propagateEvent","DynamicMapLayer","timeOptions","format","transparent","getDynamicLayers","setDynamicLayers","setLayers","getLayerDefs","setLayerDefs","getTimeOptions","setTimeOptions","identifyRequest","project","_northEast","_southWest","top","latLngToLayerPoint","bottom","bbox","dpi","href","getParamString","dynamicMapLayer","TiledMapLayer","TileLayer","zoomOffsetAllowance","correctZoomLevels","statics","MercatorZoomLevels","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","tileUrl","match","subdomains","getTileUrl","tilePoint","template","s","_getSubdomain","z","_lodMap","latestWkid","arcgisLODs","tileInfo","lods","correctResolutions","arcgisLOD","ci","correctRes","_withinPercentage","resolution","level","tokenQs","percentage","tiledMapLayer"],"mappings":"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","file":"esri-leaflet-map-service.js","sourcesContent":["var EsriLeaflet = { //jshint ignore:line\n  VERSION: '1.0.5',\n  Layers: {},\n  Services: {},\n  Controls: {},\n  Tasks: {},\n  Util: {},\n  Support: {\n    CORS: !!(window.XMLHttpRequest && 'withCredentials' in new XMLHttpRequest()),\n    pointerEvents: document.documentElement.style.pointerEvents === ''\n  }\n};\n\nif(typeof window !== 'undefined' && window.L){\n  window.L.esri = EsriLeaflet;\n}\n","(function(EsriLeaflet){\n\n  // normalize request animation frame\n  var raf = window.requestAnimationFrame ||\n     window.webkitRequestAnimationFrame ||\n     window.mozRequestAnimationFrame ||\n     window.msRequestAnimationFrame ||\n     function(cb) { return window.setTimeout(cb, 1000 / 60); };\n\n  // shallow object clone for feature properties and attributes\n  // from http://jsperf.com/cloning-an-object/2\n  function clone(obj) {\n    var target = {};\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        target[i] = obj[i];\n      }\n    }\n    return target;\n  }\n\n  // checks if 2 x,y points are equal\n  function pointsEqual(a, b) {\n    for (var i = 0; i < a.length; i++) {\n      if (a[i] !== b[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  // checks if the first and last points of a ring are equal and closes the ring\n  function closeRing(coordinates) {\n    if (!pointsEqual(coordinates[0], coordinates[coordinates.length - 1])) {\n      coordinates.push(coordinates[0]);\n    }\n    return coordinates;\n  }\n\n  // determine if polygon ring coordinates are clockwise. clockwise signifies outer ring, counter-clockwise an inner ring\n  // or hole. this logic was found at http://stackoverflow.com/questions/1165647/how-to-determine-if-a-list-of-polygon-\n  // points-are-in-clockwise-order\n  function ringIsClockwise(ringToTest) {\n    var total = 0,i = 0;\n    var rLength = ringToTest.length;\n    var pt1 = ringToTest[i];\n    var pt2;\n    for (i; i < rLength - 1; i++) {\n      pt2 = ringToTest[i + 1];\n      total += (pt2[0] - pt1[0]) * (pt2[1] + pt1[1]);\n      pt1 = pt2;\n    }\n    return (total >= 0);\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L504-L519\n  function vertexIntersectsVertex(a1, a2, b1, b2) {\n    var uaT = (b2[0] - b1[0]) * (a1[1] - b1[1]) - (b2[1] - b1[1]) * (a1[0] - b1[0]);\n    var ubT = (a2[0] - a1[0]) * (a1[1] - b1[1]) - (a2[1] - a1[1]) * (a1[0] - b1[0]);\n    var uB  = (b2[1] - b1[1]) * (a2[0] - a1[0]) - (b2[0] - b1[0]) * (a2[1] - a1[1]);\n\n    if ( uB !== 0 ) {\n      var ua = uaT / uB;\n      var ub = ubT / uB;\n\n      if ( 0 <= ua && ua <= 1 && 0 <= ub && ub <= 1 ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L521-L531\n  function arrayIntersectsArray(a, b) {\n    for (var i = 0; i < a.length - 1; i++) {\n      for (var j = 0; j < b.length - 1; j++) {\n        if (vertexIntersectsVertex(a[i], a[i + 1], b[j], b[j + 1])) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L470-L480\n  function coordinatesContainPoint(coordinates, point) {\n    var contains = false;\n    for(var i = -1, l = coordinates.length, j = l - 1; ++i < l; j = i) {\n      if (((coordinates[i][1] <= point[1] && point[1] < coordinates[j][1]) ||\n           (coordinates[j][1] <= point[1] && point[1] < coordinates[i][1])) &&\n          (point[0] < (coordinates[j][0] - coordinates[i][0]) * (point[1] - coordinates[i][1]) / (coordinates[j][1] - coordinates[i][1]) + coordinates[i][0])) {\n        contains = !contains;\n      }\n    }\n    return contains;\n  }\n\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L106-L113\n  function coordinatesContainCoordinates(outer, inner){\n    var intersects = arrayIntersectsArray(outer, inner);\n    var contains = coordinatesContainPoint(outer, inner[0]);\n    if(!intersects && contains){\n      return true;\n    }\n    return false;\n  }\n\n  // do any polygons in this array contain any other polygons in this array?\n  // used for checking for holes in arcgis rings\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L117-L172\n  function convertRingsToGeoJSON(rings){\n    var outerRings = [];\n    var holes = [];\n    var x; // iterator\n    var outerRing; // current outer ring being evaluated\n    var hole; // current hole being evaluated\n\n    // for each ring\n    for (var r = 0; r < rings.length; r++) {\n      var ring = closeRing(rings[r].slice(0));\n      if(ring.length < 4){\n        continue;\n      }\n      // is this ring an outer ring? is it clockwise?\n      if(ringIsClockwise(ring)){\n        var polygon = [ ring ];\n        outerRings.push(polygon); // push to outer rings\n      } else {\n        holes.push(ring); // counterclockwise push to holes\n      }\n    }\n\n    var uncontainedHoles = [];\n\n    // while there are holes left...\n    while(holes.length){\n      // pop a hole off out stack\n      hole = holes.pop();\n\n      // loop over all outer rings and see if they contain our hole.\n      var contained = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(coordinatesContainCoordinates(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          contained = true;\n          break;\n        }\n      }\n\n      // ring is not contained in any outer ring\n      // sometimes this happens https://github.com/Esri/esri-leaflet/issues/320\n      if(!contained){\n        uncontainedHoles.push(hole);\n      }\n    }\n\n    // if we couldn't match any holes using contains we can try intersects...\n    while(uncontainedHoles.length){\n      // pop a hole off out stack\n      hole = uncontainedHoles.pop();\n\n      // loop over all outer rings and see if any intersect our hole.\n      var intersects = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(arrayIntersectsArray(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          intersects = true;\n          break;\n        }\n      }\n\n      if(!intersects) {\n        outerRings.push([hole.reverse()]);\n      }\n    }\n\n    if(outerRings.length === 1){\n      return {\n        type: 'Polygon',\n        coordinates: outerRings[0]\n      };\n    } else {\n      return {\n        type: 'MultiPolygon',\n        coordinates: outerRings\n      };\n    }\n  }\n\n  // This function ensures that rings are oriented in the right directions\n  // outer rings are clockwise, holes are counterclockwise\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function orientRings(poly){\n    var output = [];\n    var polygon = poly.slice(0);\n    var outerRing = closeRing(polygon.shift().slice(0));\n    if(outerRing.length >= 4){\n      if(!ringIsClockwise(outerRing)){\n        outerRing.reverse();\n      }\n\n      output.push(outerRing);\n\n      for (var i = 0; i < polygon.length; i++) {\n        var hole = closeRing(polygon[i].slice(0));\n        if(hole.length >= 4){\n          if(ringIsClockwise(hole)){\n            hole.reverse();\n          }\n          output.push(hole);\n        }\n      }\n    }\n\n    return output;\n  }\n\n  // This function flattens holes in multipolygons to one array of polygons\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function flattenMultiPolygonRings(rings){\n    var output = [];\n    for (var i = 0; i < rings.length; i++) {\n      var polygon = orientRings(rings[i]);\n      for (var x = polygon.length - 1; x >= 0; x--) {\n        var ring = polygon[x].slice(0);\n        output.push(ring);\n      }\n    }\n    return output;\n  }\n\n  // convert an extent (ArcGIS) to LatLngBounds (Leaflet)\n  EsriLeaflet.Util.extentToBounds = function(extent){\n    var sw = new L.LatLng(extent.ymin, extent.xmin);\n    var ne = new L.LatLng(extent.ymax, extent.xmax);\n    return new L.LatLngBounds(sw, ne);\n  };\n\n  // convert an LatLngBounds (Leaflet) to extent (ArcGIS)\n  EsriLeaflet.Util.boundsToExtent = function(bounds) {\n    bounds = L.latLngBounds(bounds);\n    return {\n      'xmin': bounds.getSouthWest().lng,\n      'ymin': bounds.getSouthWest().lat,\n      'xmax': bounds.getNorthEast().lng,\n      'ymax': bounds.getNorthEast().lat,\n      'spatialReference': {\n        'wkid' : 4326\n      }\n    };\n  };\n\n  EsriLeaflet.Util.arcgisToGeojson = function (arcgis, idAttribute){\n    var geojson = {};\n\n    if(typeof arcgis.x === 'number' && typeof arcgis.y === 'number'){\n      geojson.type = 'Point';\n      geojson.coordinates = [arcgis.x, arcgis.y];\n    }\n\n    if(arcgis.points){\n      geojson.type = 'MultiPoint';\n      geojson.coordinates = arcgis.points.slice(0);\n    }\n\n    if(arcgis.paths) {\n      if(arcgis.paths.length === 1){\n        geojson.type = 'LineString';\n        geojson.coordinates = arcgis.paths[0].slice(0);\n      } else {\n        geojson.type = 'MultiLineString';\n        geojson.coordinates = arcgis.paths.slice(0);\n      }\n    }\n\n    if(arcgis.rings) {\n      geojson = convertRingsToGeoJSON(arcgis.rings.slice(0));\n    }\n\n    if(arcgis.geometry || arcgis.attributes) {\n      geojson.type = 'Feature';\n      geojson.geometry = (arcgis.geometry) ? EsriLeaflet.Util.arcgisToGeojson(arcgis.geometry) : null;\n      geojson.properties = (arcgis.attributes) ? clone(arcgis.attributes) : null;\n      if(arcgis.attributes) {\n        geojson.id =  arcgis.attributes[idAttribute] || arcgis.attributes.OBJECTID || arcgis.attributes.FID;\n      }\n    }\n\n    return geojson;\n  };\n\n  // GeoJSON -> ArcGIS\n  EsriLeaflet.Util.geojsonToArcGIS = function(geojson, idAttribute){\n    idAttribute = idAttribute || 'OBJECTID';\n    var spatialReference = { wkid: 4326 };\n    var result = {};\n    var i;\n\n    switch(geojson.type){\n    case 'Point':\n      result.x = geojson.coordinates[0];\n      result.y = geojson.coordinates[1];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPoint':\n      result.points = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'LineString':\n      result.paths = [geojson.coordinates.slice(0)];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiLineString':\n      result.paths = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'Polygon':\n      result.rings = orientRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPolygon':\n      result.rings = flattenMultiPolygonRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'Feature':\n      if(geojson.geometry) {\n        result.geometry = EsriLeaflet.Util.geojsonToArcGIS(geojson.geometry, idAttribute);\n      }\n      result.attributes = (geojson.properties) ? clone(geojson.properties) : {};\n      if(geojson.id){\n        result.attributes[idAttribute] = geojson.id;\n      }\n      break;\n    case 'FeatureCollection':\n      result = [];\n      for (i = 0; i < geojson.features.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.features[i], idAttribute));\n      }\n      break;\n    case 'GeometryCollection':\n      result = [];\n      for (i = 0; i < geojson.geometries.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.geometries[i], idAttribute));\n      }\n      break;\n    }\n\n    return result;\n  };\n\n  EsriLeaflet.Util.responseToFeatureCollection = function(response, idAttribute){\n    var objectIdField;\n\n    if(idAttribute){\n      objectIdField = idAttribute;\n    } else if(response.objectIdFieldName){\n      objectIdField = response.objectIdFieldName;\n    } else if(response.fields) {\n      for (var j = 0; j <= response.fields.length - 1; j++) {\n        if(response.fields[j].type === 'esriFieldTypeOID') {\n          objectIdField = response.fields[j].name;\n          break;\n        }\n      }\n    } else {\n      objectIdField = 'OBJECTID';\n    }\n\n    var featureCollection = {\n      type: 'FeatureCollection',\n      features: []\n    };\n    var features = response.features || response.results;\n    if(features.length){\n      for (var i = features.length - 1; i >= 0; i--) {\n        featureCollection.features.push(EsriLeaflet.Util.arcgisToGeojson(features[i], objectIdField));\n      }\n    }\n\n    return featureCollection;\n  };\n\n    // trim url whitespace and add a trailing slash if needed\n  EsriLeaflet.Util.cleanUrl = function(url){\n    //trim leading and trailing spaces, but not spaces inside the url\n    url = url.replace(/^\\s+|\\s+$|\\A\\s+|\\s+\\z/g, '');\n\n    //add a trailing slash to the url if the user omitted it\n    if(url[url.length-1] !== '/'){\n      url += '/';\n    }\n\n    return url;\n  };\n\n  EsriLeaflet.Util.isArcgisOnline = function(url){\n    /* hosted feature services can emit geojson natively.\n    our check for 'geojson' support will need to be revisted\n    once the functionality makes its way to ArcGIS Server*/\n    return (/\\.arcgis\\.com.*?FeatureServer/g).test(url);\n  };\n\n  EsriLeaflet.Util.geojsonTypeToArcGIS = function (geoJsonType) {\n    var arcgisGeometryType;\n    switch (geoJsonType) {\n    case 'Point':\n      arcgisGeometryType = 'esriGeometryPoint';\n      break;\n    case 'MultiPoint':\n      arcgisGeometryType = 'esriGeometryMultipoint';\n      break;\n    case 'LineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'MultiLineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'Polygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    case 'MultiPolygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    }\n    return arcgisGeometryType;\n  };\n\n  EsriLeaflet.Util.requestAnimationFrame = L.Util.bind(raf, window);\n\n  EsriLeaflet.Util.warn = function (message) {\n    if(console && console.warn) {\n      console.warn(message);\n    }\n  };\n\n})(EsriLeaflet);","(function(EsriLeaflet){\n\n  var callbacks = 0;\n\n  window._EsriLeafletCallbacks = {};\n\n  function serialize(params){\n    var data = '';\n\n    params.f = params.f || 'json';\n\n    for (var key in params){\n      if(params.hasOwnProperty(key)){\n        var param = params[key];\n        var type = Object.prototype.toString.call(param);\n        var value;\n\n        if(data.length){\n          data += '&';\n        }\n\n        if (type === '[object Array]'){\n          value = (Object.prototype.toString.call(param[0]) === '[object Object]') ? JSON.stringify(param) : param.join(',');\n        } else if (type === '[object Object]') {\n          value = JSON.stringify(param);\n        } else if (type === '[object Date]'){\n          value = param.valueOf();\n        } else {\n          value = param;\n        }\n\n        data += encodeURIComponent(key) + '=' + encodeURIComponent(value);\n      }\n    }\n\n    return data;\n  }\n\n  function createRequest(callback, context){\n    var httpRequest = new XMLHttpRequest();\n\n    httpRequest.onerror = function(e) {\n      httpRequest.onreadystatechange = L.Util.falseFn;\n\n      callback.call(context, {\n        error: {\n          code: 500,\n          message: 'XMLHttpRequest error'\n        }\n      }, null);\n    };\n\n    httpRequest.onreadystatechange = function(){\n      var response;\n      var error;\n\n      if (httpRequest.readyState === 4) {\n        try {\n          response = JSON.parse(httpRequest.responseText);\n        } catch(e) {\n          response = null;\n          error = {\n            code: 500,\n            message: 'Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error.'\n          };\n        }\n\n        if (!error && response.error) {\n          error = response.error;\n          response = null;\n        }\n\n        httpRequest.onerror = L.Util.falseFn;\n\n        callback.call(context, error, response);\n      }\n    };\n\n    return httpRequest;\n  }\n\n  // AJAX handlers for CORS (modern browsers) or JSONP (older browsers)\n  EsriLeaflet.Request = {\n    request: function(url, params, callback, context){\n      var paramString = serialize(params);\n      var httpRequest = createRequest(callback, context);\n      var requestLength = (url + '?' + paramString).length;\n\n      // request is less then 2000 characters and the browser supports CORS, make GET request with XMLHttpRequest\n      if(requestLength <= 2000 && L.esri.Support.CORS){\n        httpRequest.open('GET', url + '?' + paramString);\n        httpRequest.send(null);\n\n      // request is less more then 2000 characters and the browser supports CORS, make POST request with XMLHttpRequest\n      } else if (requestLength > 2000 && L.esri.Support.CORS){\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(paramString);\n\n      // request is less more then 2000 characters and the browser does not support CORS, make a JSONP request\n      } else if(requestLength <= 2000 && !L.esri.Support.CORS){\n        return L.esri.Request.get.JSONP(url, params, callback, context);\n\n      // request is longer then 2000 characters and the browser does not support CORS, log a warning\n      } else {\n        EsriLeaflet.Util.warn('a request to ' + url + ' was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html');\n        return;\n      }\n\n      return httpRequest;\n    },\n\n    post: {\n      XMLHTTP: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(serialize(params));\n\n        return httpRequest;\n      }\n    },\n\n    get: {\n      CORS: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n\n        httpRequest.open('GET', url + '?' + serialize(params), true);\n        httpRequest.send(null);\n\n        return httpRequest;\n      },\n      JSONP: function(url, params, callback, context){\n        var callbackId = 'c' + callbacks;\n\n        params.callback = 'window._EsriLeafletCallbacks.' + callbackId;\n\n        var script = L.DomUtil.create('script', null, document.body);\n        script.type = 'text/javascript';\n        script.src = url + '?' +  serialize(params);\n        script.id = callbackId;\n\n        window._EsriLeafletCallbacks[callbackId] = function(response){\n          if(window._EsriLeafletCallbacks[callbackId] !== true){\n            var error;\n            var responseType = Object.prototype.toString.call(response);\n\n            if(!(responseType === '[object Object]' || responseType === '[object Array]')){\n              error = {\n                error: {\n                  code: 500,\n                  message: 'Expected array or object as JSONP response'\n                }\n              };\n              response = null;\n            }\n\n            if (!error && response.error) {\n              error = response;\n              response = null;\n            }\n\n            callback.call(context, error, response);\n            window._EsriLeafletCallbacks[callbackId] = true;\n          }\n        };\n\n        callbacks++;\n\n        return {\n          id: callbackId,\n          url: script.src,\n          abort: function(){\n            window._EsriLeafletCallbacks._callback[callbackId]({\n              code: 0,\n              message: 'Request aborted.'\n            });\n          }\n        };\n      }\n    }\n  };\n\n  // choose the correct AJAX handler depending on CORS support\n  EsriLeaflet.get = (EsriLeaflet.Support.CORS) ? EsriLeaflet.Request.get.CORS : EsriLeaflet.Request.get.JSONP;\n\n  // always use XMLHttpRequest for posts\n  EsriLeaflet.post = EsriLeaflet.Request.post.XMLHTTP;\n\n  // expose a common request method the uses GET\\POST based on request length\n  EsriLeaflet.request = EsriLeaflet.Request.request;\n\n})(EsriLeaflet);","EsriLeaflet.Services.Service = L.Class.extend({\n\n  includes: L.Mixin.Events,\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  initialize: function (options) {\n    options = options || {};\n    this._requestQueue = [];\n    this._authenticating = false;\n    L.Util.setOptions(this, options);\n    this.options.url = EsriLeaflet.Util.cleanUrl(this.options.url);\n  },\n\n  get: function (path, params, callback, context) {\n    return this._request('get', path, params, callback, context);\n  },\n\n  post: function (path, params, callback, context) {\n    return this._request('post', path, params, callback, context);\n  },\n\n  request: function (path, params, callback, context) {\n    return this._request('request', path, params, callback, context);\n  },\n\n  metadata: function (callback, context) {\n    return this._request('get', '', {}, callback, context);\n  },\n\n  authenticate: function(token){\n    this._authenticating = false;\n    this.options.token = token;\n    this._runQueue();\n    return this;\n  },\n\n  _request: function(method, path, params, callback, context){\n    this.fire('requeststart', {\n      url: this.options.url + path,\n      params: params,\n      method: method\n    });\n\n    var wrappedCallback = this._createServiceCallback(method, path, params, callback, context);\n\n    if (this.options.token) {\n      params.token = this.options.token;\n    }\n\n    if (this._authenticating) {\n      this._requestQueue.push([method, path, params, callback, context]);\n      return;\n    } else {\n      var url = (this.options.proxy) ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\n\n      if((method === 'get' || method === 'request') && !this.options.useCors){\n        return EsriLeaflet.Request.get.JSONP(url, params, wrappedCallback);\n      } else {\n        return EsriLeaflet[method](url, params, wrappedCallback);\n      }\n    }\n  },\n\n  _createServiceCallback: function(method, path, params, callback, context){\n    return L.Util.bind(function(error, response){\n\n      if (error && (error.code === 499 || error.code === 498)) {\n        this._authenticating = true;\n\n        this._requestQueue.push([method, path, params, callback, context]);\n\n        // fire an event for users to handle and re-authenticate\n        this.fire('authenticationrequired', {\n          authenticate: L.Util.bind(this.authenticate, this)\n        });\n\n        // if the user has access to a callback they can handle the auth error\n        error.authenticate = L.Util.bind(this.authenticate, this);\n      }\n\n      callback.call(context, error, response);\n\n      if(error) {\n        this.fire('requesterror', {\n          url: this.options.url + path,\n          params: params,\n          message: error.message,\n          code: error.code,\n          method: method\n        });\n      } else {\n        this.fire('requestsuccess', {\n          url: this.options.url + path,\n          params: params,\n          response: response,\n          method: method\n        });\n      }\n\n      this.fire('requestend', {\n        url: this.options.url + path,\n        params: params,\n        method: method\n      });\n    }, this);\n  },\n\n  _runQueue: function(){\n    for (var i = this._requestQueue.length - 1; i >= 0; i--) {\n      var request = this._requestQueue[i];\n      var method = request.shift();\n      this[method].apply(this, request);\n    }\n    this._requestQueue = [];\n  }\n\n});\n\nEsriLeaflet.Services.service = function(params){\n  return new EsriLeaflet.Services.Service(params);\n};\n","EsriLeaflet.Services.MapService = EsriLeaflet.Services.Service.extend({\n\n  identify: function () {\n    return new EsriLeaflet.Tasks.identifyFeatures(this);\n  },\n\n  find: function () {\n    return new EsriLeaflet.Tasks.Find(this);\n  },\n\n  query: function () {\n    return new EsriLeaflet.Tasks.Query(this);\n  }\n\n});\n\nEsriLeaflet.Services.mapService = function(params){\n  return new EsriLeaflet.Services.MapService(params);\n};","EsriLeaflet.Tasks.Task = L.Class.extend({\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  //Generate a method for each methodName:paramName in the setters for this task.\n  generateSetter: function(param, context){\n    return L.Util.bind(function(value){\n      this.params[param] = value;\n      return this;\n    }, context);\n  },\n\n  initialize: function(endpoint){\n    // endpoint can be either a url (and options) for an ArcGIS Rest Service or an instance of EsriLeaflet.Service\n    if(endpoint.request && endpoint.options){\n      this._service = endpoint;\n      L.Util.setOptions(this, endpoint.options);\n    } else {\n      L.Util.setOptions(this, endpoint);\n      this.options.url = L.esri.Util.cleanUrl(endpoint.url);\n    }\n\n    // clone default params into this object\n    this.params = L.Util.extend({}, this.params || {});\n\n    // generate setter methods based on the setters object implimented a child class\n    if(this.setters){\n      for (var setter in this.setters){\n        var param = this.setters[setter];\n        this[setter] = this.generateSetter(param, this);\n      }\n    }\n  },\n\n  token: function(token){\n    if(this._service){\n      this._service.authenticate(token);\n    } else {\n      this.params.token = token;\n    }\n    return this;\n  },\n\n  request: function(callback, context){\n    if(this._service){\n      return this._service.request(this.path, this.params, callback, context);\n    } else {\n      return this._request('request', this.path, this.params, callback, context);\n    }\n  },\n\n  _request: function(method, path, params, callback, context){\n    var url = (this.options.proxy) ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\n    if((method === 'get' || method === 'request') && !this.options.useCors){\n      return EsriLeaflet.Request.get.JSONP(url, params, callback, context);\n    } else{\n      return EsriLeaflet[method](url, params, callback, context);\n    }\n  }\n});","EsriLeaflet.Tasks.Identify = EsriLeaflet.Tasks.Task.extend({\n  path: 'identify',\n\n  between: function(start, end){\n    this.params.time = [start.valueOf(), end.valueOf()];\n    return this;\n  }\n});\n","EsriLeaflet.Tasks.IdentifyFeatures = EsriLeaflet.Tasks.Identify.extend({\n  setters: {\n    'layers': 'layers',\n    'precision': 'geometryPrecision',\n    'tolerance': 'tolerance',\n    'returnGeometry': 'returnGeometry'\n  },\n\n  params: {\n    sr: 4326,\n    layers: 'all',\n    tolerance: 3,\n    returnGeometry: true\n  },\n\n  on: function(map){\n    var extent = EsriLeaflet.Util.boundsToExtent(map.getBounds());\n    var size = map.getSize();\n    this.params.imageDisplay = [size.x, size.y, 96];\n    this.params.mapExtent = [extent.xmin, extent.ymin, extent.xmax, extent.ymax];\n    return this;\n  },\n\n  at: function(latlng){\n    latlng = L.latLng(latlng);\n    this.params.geometry = [latlng.lng, latlng.lat];\n    this.params.geometryType = 'esriGeometryPoint';\n    return this;\n  },\n\n  layerDef: function (id, where){\n    this.params.layerDefs = (this.params.layerDefs) ? this.params.layerDefs + ';' : '';\n    this.params.layerDefs += ([id, where]).join(':');\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * (1 - factor);\n    return this;\n  },\n\n  run: function (callback, context){\n    return this.request(function(error, response){\n      // immediately invoke with an error\n      if(error) {\n        callback.call(context, error, undefined, response);\n        return;\n\n      // ok no error lets just assume we have features...\n      } else {\n        var featureCollection = EsriLeaflet.Util.responseToFeatureCollection(response);\n        response.results = response.results.reverse();\n        for (var i = 0; i < featureCollection.features.length; i++) {\n          var feature = featureCollection.features[i];\n          feature.layerId = response.results[i].layerId;\n        }\n        callback.call(context, undefined, featureCollection, response);\n      }\n    });\n  }\n});\n\nEsriLeaflet.Tasks.identifyFeatures = function(params){\n  return new EsriLeaflet.Tasks.IdentifyFeatures(params);\n};","EsriLeaflet.Tasks.Query = EsriLeaflet.Tasks.Task.extend({\n  setters: {\n    'offset': 'offset',\n    'limit': 'limit',\n    'fields': 'outFields',\n    'precision': 'geometryPrecision',\n    'featureIds': 'objectIds',\n    'returnGeometry': 'returnGeometry',\n    'token': 'token'\n  },\n\n  path: 'query',\n\n  params: {\n    returnGeometry: true,\n    where: '1=1',\n    outSr: 4326,\n    outFields: '*'\n  },\n\n  within: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelContains'; // will make code read layer within geometry, to the api this will reads geometry contains layer\n    return this;\n  },\n\n  intersects: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    return this;\n  },\n\n  contains: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelWithin'; // will make code read layer contains geometry, to the api this will reads geometry within layer\n    return this;\n  },\n\n  // crosses: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelCrosses';\n  //   return this;\n  // },\n\n  // touches: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelTouches';\n  //   return this;\n  // },\n\n  overlaps: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelOverlaps';\n    return this;\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  nearby: function(latlng, radius){\n    latlng = L.latLng(latlng);\n    this.params.geometry = [latlng.lng, latlng.lat];\n    this.params.geometryType = 'esriGeometryPoint';\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    this.params.units = 'esriSRUnit_Meter';\n    this.params.distance = radius;\n    this.params.inSr = 4326;\n    return this;\n  },\n\n  where: function(string){\n    // instead of converting double-quotes to single quotes, pass as is, and provide a more informative message if a 400 is encountered\n    this.params.where = string;\n    return this;\n  },\n\n  between: function(start, end){\n    this.params.time = [start.valueOf(), end.valueOf()];\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * factor;\n    return this;\n  },\n\n  orderBy: function(fieldName, order){\n    order = order || 'ASC';\n    this.params.orderByFields = (this.params.orderByFields) ? this.params.orderByFields + ',' : '';\n    this.params.orderByFields += ([fieldName, order]).join(' ');\n    return this;\n  },\n\n  run: function(callback, context){\n    this._cleanParams();\n\n    // if the service is hosted on arcgis online request geojson directly\n    if(EsriLeaflet.Util.isArcgisOnline(this.options.url)){\n      this.params.f = 'geojson';\n\n      return this.request(function(error, response){\n        this._trapSQLerrors(error);\n        callback.call(context, error, response, response);\n      }, this);\n\n    // otherwise convert it in the callback then pass it on\n    } else {\n      return this.request(function(error, response){\n        this._trapSQLerrors(error);\n        callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n      }, this);\n    }\n  },\n\n  count: function(callback, context){\n    this._cleanParams();\n    this.params.returnCountOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.count), response);\n    }, context);\n  },\n\n  ids: function(callback, context){\n    this._cleanParams();\n    this.params.returnIdsOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.objectIds), response);\n    }, context);\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  bounds: function(callback, context){\n    this._cleanParams();\n    this.params.returnExtentOnly = true;\n    return this.request(function(error, response){\n      callback.call(context, error, (response && response.extent && EsriLeaflet.Util.extentToBounds(response.extent)), response);\n    }, context);\n  },\n\n  // only valid for image services\n  pixelSize: function(point){\n    point = L.point(point);\n    this.params.pixelSize = [point.x,point.y];\n    return this;\n  },\n\n  // only valid for map services\n  layer: function(layer){\n    this.path = layer + '/query';\n    return this;\n  },\n\n  _trapSQLerrors: function(error){\n    if (error){\n      if (error.code === '400'){\n        EsriLeaflet.Util.warn('one common syntax error in query requests is encasing string values in double quotes instead of single quotes');\n      }\n    }\n  },\n\n  _cleanParams: function(){\n    delete this.params.returnIdsOnly;\n    delete this.params.returnExtentOnly;\n    delete this.params.returnCountOnly;\n  },\n\n  _setGeometry: function(geometry) {\n    this.params.inSr = 4326;\n\n    // convert bounds to extent and finish\n    if ( geometry instanceof L.LatLngBounds ) {\n      // set geometry + geometryType\n      this.params.geometry = EsriLeaflet.Util.boundsToExtent(geometry);\n      this.params.geometryType = 'esriGeometryEnvelope';\n      return;\n    }\n\n    // convert L.Marker > L.LatLng\n    if(geometry.getLatLng){\n      geometry = geometry.getLatLng();\n    }\n\n    // convert L.LatLng to a geojson point and continue;\n    if (geometry instanceof L.LatLng) {\n      geometry = {\n        type: 'Point',\n        coordinates: [geometry.lng, geometry.lat]\n      };\n    }\n\n    // handle L.GeoJSON, pull out the first geometry\n    if ( geometry instanceof L.GeoJSON ) {\n      //reassign geometry to the GeoJSON value  (we are assuming that only one feature is present)\n      geometry = geometry.getLayers()[0].feature.geometry;\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n    }\n\n    // Handle L.Polyline and L.Polygon\n    if (geometry.toGeoJSON) {\n      geometry = geometry.toGeoJSON();\n    }\n\n    // handle GeoJSON feature by pulling out the geometry\n    if ( geometry.type === 'Feature' ) {\n      // get the geometry of the geojson feature\n      geometry = geometry.geometry;\n    }\n\n    // confirm that our GeoJSON is a point, line or polygon\n    if ( geometry.type === 'Point' ||  geometry.type === 'LineString' || geometry.type === 'Polygon') {\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n      return;\n    }\n\n    // warn the user if we havn't found a\n    /* global console */\n    EsriLeaflet.Util.warn('invalid geometry passed to spatial query. Should be an L.LatLng, L.LatLngBounds or L.Marker or a GeoJSON Point Line or Polygon object');\n\n    return;\n  }\n});\n\nEsriLeaflet.Tasks.query = function(params){\n  return new EsriLeaflet.Tasks.Query(params);\n};","EsriLeaflet.Tasks.Find = EsriLeaflet.Tasks.Task.extend({\n  setters: {\n    // method name > param name\n    'contains': 'contains',\n    'text': 'searchText',\n    'fields': 'searchFields', // denote an array or single string\n    'spatialReference': 'sr',\n    'sr': 'sr',\n    'layers': 'layers',\n    'returnGeometry': 'returnGeometry',\n    'maxAllowableOffset': 'maxAllowableOffset',\n    'precision': 'geometryPrecision',\n    'dynamicLayers': 'dynamicLayers',\n    'returnZ' : 'returnZ',\n    'returnM' : 'returnM',\n    'gdbVersion' : 'gdbVersion',\n    'token' : 'token'\n  },\n\n  path: 'find',\n\n  params: {\n    sr: 4326,\n    contains: true,\n    returnGeometry: true,\n    returnZ: true,\n    returnM: false\n  },\n\n  layerDefs: function (id, where) {\n    this.params.layerDefs = (this.params.layerDefs) ? this.params.layerDefs + ';' : '';\n    this.params.layerDefs += ([id, where]).join(':');\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * factor;\n    return this;\n  },\n\n  run: function (callback, context) {\n    return this.request(function(error, response){\n      callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n    }, context);\n  }\n});\n\nEsriLeaflet.Tasks.find = function (params) {\n  return new EsriLeaflet.Tasks.Find(params);\n};","EsriLeaflet.Layers.RasterLayer =  L.Class.extend({\n  includes: L.Mixin.Events,\n\n  options: {\n    opacity: 1,\n    position: 'front',\n    f: 'image'\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n\n    this._update = L.Util.limitExecByInterval(this._update, this.options.updateInterval, this);\n\n    if (map.options.crs && map.options.crs.code) {\n      var sr = map.options.crs.code.split(':')[1];\n      this.options.bboxSR = sr;\n      this.options.imageSR = sr;\n    }\n\n    map.on('moveend', this._update, this);\n\n    // if we had an image loaded and it matches the\n    // current bounds show the image otherwise remove it\n    if(this._currentImage && this._currentImage._bounds.equals(this._map.getBounds())){\n      map.addLayer(this._currentImage);\n    } else if(this._currentImage) {\n      this._map.removeLayer(this._currentImage);\n      this._currentImage = null;\n    }\n\n    this._update();\n\n    if(this._popup){\n      this._map.on('click', this._getPopupData, this);\n      this._map.on('dblclick', this._resetPopupState, this);\n    }\n  },\n\n  bindPopup: function(fn, popupOptions){\n    this._shouldRenderPopup = false;\n    this._lastClick = false;\n    this._popup = L.popup(popupOptions);\n    this._popupFunction = fn;\n    if(this._map){\n      this._map.on('click', this._getPopupData, this);\n      this._map.on('dblclick', this._resetPopupState, this);\n    }\n    return this;\n  },\n\n  unbindPopup: function(){\n    if(this._map){\n      this._map.closePopup(this._popup);\n      this._map.off('click', this._getPopupData, this);\n      this._map.off('dblclick', this._resetPopupState, this);\n    }\n    this._popup = false;\n    return this;\n  },\n\n  onRemove: function (map) {\n    if (this._currentImage) {\n      this._map.removeLayer(this._currentImage);\n    }\n\n    if(this._popup){\n      this._map.off('click', this._getPopupData, this);\n      this._map.off('dblclick', this._resetPopupState, this);\n    }\n\n    this._map.off('moveend', this._update, this);\n    this._map = null;\n  },\n\n  addTo: function(map){\n    map.addLayer(this);\n    return this;\n  },\n\n  removeFrom: function(map){\n    map.removeLayer(this);\n    return this;\n  },\n\n  bringToFront: function(){\n    this.options.position = 'front';\n    if(this._currentImage){\n      this._currentImage.bringToFront();\n    }\n    return this;\n  },\n\n  bringToBack: function(){\n    this.options.position = 'back';\n    if(this._currentImage){\n      this._currentImage.bringToBack();\n    }\n    return this;\n  },\n\n  getAttribution: function () {\n    return this.options.attribution;\n  },\n\n  getOpacity: function(){\n    return this.options.opacity;\n  },\n\n  setOpacity: function(opacity){\n    this.options.opacity = opacity;\n    if (this._currentImage) {\n      this._currentImage.setOpacity(opacity);\n    }\n    return this;\n  },\n\n  getTimeRange: function(){\n    return [this.options.from, this.options.to];\n  },\n\n  setTimeRange: function(from, to){\n    this.options.from = from;\n    this.options.to = to;\n    this._update();\n    return this;\n  },\n\n  metadata: function(callback, context){\n    this._service.metadata(callback, context);\n    return this;\n  },\n\n  authenticate: function(token){\n    this._service.authenticate(token);\n    return this;\n  },\n\n  _renderImage: function(url, bounds){\n    if(this._map){\n      // create a new image overlay and add it to the map\n      // to start loading the image\n      // opacity is 0 while the image is loading\n      var image = new L.ImageOverlay(url, bounds, {\n        opacity: 0\n      }).addTo(this._map);\n\n      // once the image loads\n      image.once('load', function(e){\n        var newImage = e.target;\n        var oldImage = this._currentImage;\n\n        // if the bounds of this image matches the bounds that\n        // _renderImage was called with and we have a map with the same bounds\n        // hide the old image if there is one and set the opacity\n        // of the new image otherwise remove the new image\n        if(newImage._bounds.equals(bounds) && newImage._bounds.equals(this._map.getBounds())){\n          this._currentImage = newImage;\n\n          if(this.options.position === 'front'){\n            this.bringToFront();\n          } else {\n            this.bringToBack();\n          }\n\n          if(this._map && this._currentImage._map){\n            this._currentImage.setOpacity(this.options.opacity);\n          } else {\n            this._currentImage._map.removeLayer(this._currentImage);\n          }\n\n          if(oldImage && this._map) {\n            this._map.removeLayer(oldImage);\n          }\n\n          if(oldImage && oldImage._map){\n            oldImage._map.removeLayer(oldImage);\n          }\n        } else {\n          this._map.removeLayer(newImage);\n        }\n\n        this.fire('load', {\n          bounds: bounds\n        });\n\n      }, this);\n\n      this.fire('loading', {\n        bounds: bounds\n      });\n    }\n  },\n\n  _update: function () {\n    if(!this._map){\n      return;\n    }\n\n    var zoom = this._map.getZoom();\n    var bounds = this._map.getBounds();\n\n    if(this._animatingZoom){\n      return;\n    }\n\n    if (this._map._panTransition && this._map._panTransition._inProgress) {\n      return;\n    }\n\n    if (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\n      if (this._currentImage) {\n        this._currentImage._map.removeLayer(this._currentImage);\n      }\n      return;\n    }\n    var params = this._buildExportParams();\n\n    this._requestExport(params, bounds);\n  },\n\n  // TODO: refactor these into raster layer\n  _renderPopup: function(latlng, error, results, response){\n    latlng = L.latLng(latlng);\n    if(this._shouldRenderPopup && this._lastClick.equals(latlng)){\n      //add the popup to the map where the mouse was clicked at\n      var content = this._popupFunction(error, results, response);\n      if (content) {\n        this._popup.setLatLng(latlng).setContent(content).openOn(this._map);\n      }\n    }\n  },\n\n  _resetPopupState: function(e){\n    this._shouldRenderPopup = false;\n    this._lastClick = e.latlng;\n  },\n\n  // from https://github.com/Leaflet/Leaflet/blob/v0.7.2/src/layer/FeatureGroup.js\n  // @TODO remove at Leaflet 0.8\n  _propagateEvent: function (e) {\n    e = L.extend({\n      layer: e.target,\n      target: this\n    }, e);\n    this.fire(e.type, e);\n  }\n});\n","EsriLeaflet.Layers.DynamicMapLayer = EsriLeaflet.Layers.RasterLayer.extend({\n\n  options: {\n    updateInterval: 150,\n    layers: false,\n    layerDefs: false,\n    timeOptions: false,\n    format: 'png24',\n    transparent: true,\n    f: 'json'\n  },\n\n  initialize: function (options) {\n    options.url = EsriLeaflet.Util.cleanUrl(options.url);\n    this._service = new EsriLeaflet.Services.MapService(options);\n    this._service.on('authenticationrequired requeststart requestend requesterror requestsuccess', this._propagateEvent, this);\n    if ((options.proxy || options.token) && options.f !== 'json'){\n      options.f = 'json';\n    }\n    L.Util.setOptions(this, options);\n  },\n\n  getDynamicLayers: function(){\n    return this.options.dynamicLayers;\n  },\n\n  setDynamicLayers: function(dynamicLayers){\n    this.options.dynamicLayers = dynamicLayers;\n    this._update();\n    return this;\n  },\n\n  getLayers: function(){\n    return this.options.layers;\n  },\n\n  setLayers: function(layers){\n    this.options.layers = layers;\n    this._update();\n    return this;\n  },\n\n  getLayerDefs: function(){\n    return this.options.layerDefs;\n  },\n\n  setLayerDefs: function(layerDefs){\n    this.options.layerDefs = layerDefs;\n    this._update();\n    return this;\n  },\n\n  getTimeOptions: function(){\n    return this.options.timeOptions;\n  },\n\n  setTimeOptions: function(timeOptions){\n    this.options.timeOptions = timeOptions;\n    this._update();\n    return this;\n  },\n\n  query: function(){\n    return this._service.query();\n  },\n\n  identify: function(){\n    return this._service.identify();\n  },\n\n  find: function(){\n    return this._service.find();\n  },\n\n  _getPopupData: function(e){\n    var callback = L.Util.bind(function(error, featureCollection, response) {\n      if(error) { return; } // we really can't do anything here but authenticate or requesterror will fire\n      setTimeout(L.Util.bind(function(){\n        this._renderPopup(e.latlng, error, featureCollection, response);\n      }, this), 300);\n    }, this);\n\n    var identifyRequest = this.identify().on(this._map).at(e.latlng);\n\n    if(this.options.layers){\n      identifyRequest.layers('visible:' + this.options.layers.join(','));\n    } else {\n      identifyRequest.layers('visible');\n    }\n\n    identifyRequest.run(callback);\n\n    // set the flags to show the popup\n    this._shouldRenderPopup = true;\n    this._lastClick = e.latlng;\n  },\n\n  _buildExportParams: function () {\n    var bounds = this._map.getBounds();\n    var size = this._map.getSize();\n    var ne = this._map.options.crs.project(bounds._northEast);\n    var sw = this._map.options.crs.project(bounds._southWest);\n\n    //ensure that we don't ask ArcGIS Server for a taller image than we have actual map displaying\n    var top = this._map.latLngToLayerPoint(bounds._northEast);\n    var bottom = this._map.latLngToLayerPoint(bounds._southWest);\n\n    if (top.y > 0 || bottom.y < size.y){\n      size.y = bottom.y - top.y;\n    }\n\n    var params = {\n      bbox: [sw.x, sw.y, ne.x, ne.y].join(','),\n      size: size.x + ',' + size.y,\n      dpi: 96,\n      format: this.options.format,\n      transparent: this.options.transparent,\n      bboxSR: this.options.bboxSR,\n      imageSR: this.options.imageSR\n    };\n\n    if(this.options.dynamicLayers){\n      params.dynamicLayers = this.options.dynamicLayers;\n    }\n\n    if(this.options.layers){\n      params.layers = 'show:' + this.options.layers.join(',');\n    }\n\n    if(this.options.layerDefs){\n      params.layerDefs = JSON.stringify(this.options.layerDefs);\n    }\n\n    if(this.options.timeOptions){\n      params.timeOptions = JSON.stringify(this.options.timeOptions);\n    }\n\n    if(this.options.from && this.options.to){\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n\n    if(this._service.options.token) {\n      params.token = this._service.options.token;\n    }\n\n    return params;\n  },\n\n  _requestExport: function (params, bounds) {\n    if(this.options.f === 'json'){\n      this._service.request('export', params, function(error, response){\n        if(error) { return; } // we really can't do anything here but authenticate or requesterror will fire\n        this._renderImage(response.href, bounds);\n      }, this);\n    } else {\n      params.f = 'image';\n      this._renderImage(this.options.url + 'export' + L.Util.getParamString(params), bounds);\n    }\n  }\n});\n\nEsriLeaflet.DynamicMapLayer = EsriLeaflet.Layers.DynamicMapLayer;\n\nEsriLeaflet.Layers.dynamicMapLayer = function(options){\n  return new EsriLeaflet.Layers.DynamicMapLayer(options);\n};\n\nEsriLeaflet.dynamicMapLayer = function(options){\n  return new EsriLeaflet.Layers.DynamicMapLayer(options);\n};\n","EsriLeaflet.Layers.TiledMapLayer = L.TileLayer.extend({\n  options: {\n    zoomOffsetAllowance: 0.1,\n    correctZoomLevels: true\n  },\n\n  statics: {\n    MercatorZoomLevels: {\n      '0':156543.03392799999,\n      '1':78271.516963999893,\n      '2':39135.758482000099,\n      '3':19567.879240999901,\n      '4':9783.9396204999593,\n      '5':4891.9698102499797,\n      '6':2445.9849051249898,\n      '7':1222.9924525624899,\n      '8':611.49622628138002,\n      '9':305.74811314055802,\n      '10':152.874056570411,\n      '11':76.437028285073197,\n      '12':38.218514142536598,\n      '13':19.109257071268299,\n      '14':9.5546285356341496,\n      '15':4.7773142679493699,\n      '16':2.38865713397468,\n      '17':1.1943285668550501,\n      '18':0.59716428355981699,\n      '19':0.29858214164761698,\n      '20':0.14929107082381,\n      '21':0.07464553541191,\n      '22':0.0373227677059525,\n      '23':0.0186613838529763\n    }\n  },\n\n  initialize: function(options){\n    options.url = EsriLeaflet.Util.cleanUrl(options.url);\n    options = L.Util.setOptions(this, options);\n\n    // set the urls\n    //this.url = L.esri.Util.cleanUrl(url);\n    this.tileUrl = L.esri.Util.cleanUrl(options.url) + 'tile/{z}/{y}/{x}';\n    this._service = new L.esri.Services.MapService(options);\n    this._service.on('authenticationrequired requeststart requestend requesterror requestsuccess', this._propagateEvent, this);\n\n    //if this is looking at the AGO tiles subdomain insert the subdomain placeholder\n    if(this.tileUrl.match('://tiles.arcgisonline.com')){\n      this.tileUrl = this.tileUrl.replace('://tiles.arcgisonline.com', '://tiles{s}.arcgisonline.com');\n      options.subdomains = ['1', '2', '3', '4'];\n    }\n\n    if(this.options.token) {\n      this.tileUrl += ('?token=' + this.options.token);\n    }\n\n    // init layer by calling TileLayers initialize method\n    L.TileLayer.prototype.initialize.call(this, this.tileUrl, options);\n  },\n\n  getTileUrl: function (tilePoint) {\n    return L.Util.template(this.tileUrl, L.extend({\n      s: this._getSubdomain(tilePoint),\n      z: this._lodMap[tilePoint.z] || tilePoint.z, // try lod map first, then just defualt to zoom level\n      x: tilePoint.x,\n      y: tilePoint.y\n    }, this.options));\n  },\n\n  onAdd: function(map){\n    if (!this._lodMap && this.options.correctZoomLevels) {\n      this._lodMap = {}; // make sure we always have an lod map even if its empty\n      this.metadata(function(error, metadata) {\n        if(!error) {\n          var sr = metadata.spatialReference.latestWkid || metadata.spatialReference.wkid;\n\n          if (sr === 102100 || sr === 3857) {\n            //create the zoom level data\n            var arcgisLODs = metadata.tileInfo.lods;\n            var correctResolutions = EsriLeaflet.Layers.TiledMapLayer.MercatorZoomLevels;\n\n            for(var i = 0; i < arcgisLODs.length; i++) {\n              var arcgisLOD = arcgisLODs[i];\n              for(var ci in correctResolutions) {\n                var correctRes = correctResolutions[ci];\n\n                if(this._withinPercentage(arcgisLOD.resolution, correctRes, this.options.zoomOffsetAllowance)) {\n                  this._lodMap[ci] = arcgisLOD.level;\n                  break;\n                }\n              }\n            }\n          } else {\n            EsriLeaflet.Util.warn('L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html');\n          }\n        }\n\n        L.TileLayer.prototype.onAdd.call(this, map);\n      }, this);\n    } else {\n      L.TileLayer.prototype.onAdd.call(this, map);\n    }\n  },\n\n  metadata: function(callback, context){\n    this._service.metadata(callback, context);\n    return this;\n  },\n\n  identify: function(){\n    return this._service.identify();\n  },\n\n  authenticate: function(token){\n    var tokenQs = '?token=' + token;\n    this.tileUrl = (this.options.token) ? this.tileUrl.replace(/\\?token=(.+)/g, tokenQs) : this.tileUrl + tokenQs;\n    this.options.token = token;\n    this._service.authenticate(token);\n    return this;\n  },\n\n  // from https://github.com/Leaflet/Leaflet/blob/v0.7.2/src/layer/FeatureGroup.js\n  // @TODO remove at Leaflet 0.8\n  _propagateEvent: function (e) {\n    e = L.extend({\n      layer: e.target,\n      target: this\n    }, e);\n    this.fire(e.type, e);\n  },\n\n  _withinPercentage: function (a, b, percentage) {\n    var diff = Math.abs((a/b) - 1);\n    return diff < percentage;\n  }\n});\n\nL.esri.TiledMapLayer = L.esri.Layers.tiledMapLayer;\n\nL.esri.Layers.tiledMapLayer = function(options){\n  return new L.esri.Layers.TiledMapLayer(options);\n};\n\nL.esri.tiledMapLayer = function(options){\n  return new L.esri.Layers.TiledMapLayer(options);\n};\n"]}